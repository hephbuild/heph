edition = "2023";
package heph.plugin.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/any.proto";
import "google/protobuf/field_mask.proto";
import "heph/plugin/v1/tref.proto";

message Sandbox {
  message Tool {
    TargetRefWithOutput ref = 1;
    string group = 2;
    bool hash = 4;
    string id = 5;
  }
  repeated Tool tools = 1;

  message Dep {
    enum Mode {
      MODE_UNSPECIFIED = 0; // deps will get expanded in sandbox
      MODE_LINK = 1; // deps will get expanded in sandbox through hard links
      MODE_NONE = 2; // deps will not get expanded
    }

    TargetRefWithOutput ref = 1;
    Mode link = 5;
    string group = 2;
    bool runtime = 3;
    bool hash = 4;
    string id = 6;
  }
  repeated Dep deps = 2;

  message Env {
    oneof value {
      string literal = 1;
      bool pass = 2;
    }
    bool hash = 4;
    bool append = 5;
    string append_prefix = 6;
  }
  map<string, Env> env = 3;
}

message TargetDef {
  message InputOrigin {
    string id = 3;
  }

  message Input {
    enum Mode {
      MODE_UNSPECIFIED = 0; // deps will get expanded in sandbox
      MODE_LINK = 1; // deps will get expanded in sandbox through hard links
      MODE_NONE = 2; // deps will not get expanded
    }

    TargetRefWithOutput ref = 1;
    Mode link = 2;
    InputOrigin origin = 3;
  }

  message Output {
    string group = 1;
    repeated Path paths = 2;
  }

  message Path {
    enum CodegenMode {
      CODEGEN_MODE_UNSPECIFIED = 0;
      CODEGEN_MODE_COPY = 2;
      CODEGEN_MODE_LINK = 3;
    }
    oneof content {
      string file_path = 1;
      string dir_path = 2;
      string glob = 3;
    }
    CodegenMode codegen_tree = 5;
    bool collect = 6;
  }

  TargetRef ref = 1;
  google.protobuf.Any def = 2;
  repeated Input inputs = 3;
  repeated Output outputs = 4;
  repeated Path support_files = 11;
  bool cache = 5;
  bool disable_remote_cache = 9;

  bool pty = 8;
  bytes hash = 10;
}

message TargetSpec {
  TargetRef ref = 1;
  string driver = 2;
  map<string, google.protobuf.Value> config = 3;
  repeated string labels = 4;
  Sandbox transitive = 5;
}