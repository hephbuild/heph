syntax = "proto3";
package heph.plugin.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/any.proto";
import "google/protobuf/field_mask.proto";

message TargetRef {
  string package = 1;
  string name = 2;
  map<string, string> args = 4;
}

message TargetRefWithOutput {
  string package = 1;
  string name = 2;
  string driver = 3;
  map<string, string> args = 4;
  optional string output = 5;
}

message TargetDef {
  message InputOrigin {
    google.protobuf.Any meta = 2;
    string id = 3;
  }

  message Input {
    enum Mode {
      MODE_UNSPECIFIED = 0; // deps will get expanded in sandbox
      MODE_LINK = 1; // deps will get expanded in sandbox through hard links
      MODE_NONE = 2; // deps will not get expanded
    }

    TargetRefWithOutput ref = 1;
    Mode link = 2;
    InputOrigin origin = 3;
  }

  TargetRef ref = 1;
  google.protobuf.Any def = 2;
  repeated Input inputs = 3;
  repeated string outputs = 4;
  bool cache = 5;

  message CollectOutput {
    string group = 1;
    repeated string paths = 2;
  }

  repeated CollectOutput collect_outputs = 6;

  message CodegenTree {
    enum Mode {
      CODEGEN_MODE_UNSPECIFIED = 0;
      CODEGEN_MODE_COPY = 2;
      CODEGEN_MODE_LINK = 3;
    }

    Mode mode = 1;
    repeated string paths = 2;
  }

  CodegenTree codegen_tree = 7;

  bool pty = 8;
}

message TargetSpec {
  TargetRef ref = 1;
  string driver = 2;
  map<string, google.protobuf.Value> config = 3;
}