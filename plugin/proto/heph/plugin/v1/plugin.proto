edition = "2023";
package heph.plugin.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/any.proto";
import "google/protobuf/field_mask.proto";
import "heph/plugin/v1/tref.proto";
import "google/protobuf/go_features.proto";
option features.(pb.go).api_level = API_OPAQUE;

message TargetDef {
  message InputOrigin {
    google.protobuf.Any meta = 2;
    string id = 3;
  }

  message Input {
    enum Mode {
      MODE_UNSPECIFIED = 0; // deps will get expanded in sandbox
      MODE_LINK = 1; // deps will get expanded in sandbox through hard links
      MODE_NONE = 2; // deps will not get expanded
    }

    TargetRefWithOutput ref = 1;
    Mode link = 2;
    InputOrigin origin = 3;
  }

  TargetRef ref = 1;
  google.protobuf.Any def = 2;
  repeated Input inputs = 3;
  repeated string outputs = 4;
  bool cache = 5;
  bool disable_remote_cache = 9;

  message CollectOutput {
    string group = 1;
    repeated string paths = 2;
  }

  repeated CollectOutput collect_outputs = 6;

  message CodegenTree {
    enum Mode {
      CODEGEN_MODE_UNSPECIFIED = 0;
      CODEGEN_MODE_COPY = 2;
      CODEGEN_MODE_LINK = 3;
    }

    Mode mode = 1;
    string path = 2;
    bool is_dir = 3;
  }

  repeated CodegenTree codegen_tree = 7;

  bool pty = 8;
  bytes hash = 10;
}

message TargetSpec {
  TargetRef ref = 1;
  string driver = 2;
  map<string, google.protobuf.Value> config = 3;
  repeated string labels = 4;
}