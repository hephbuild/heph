edition = "2023";
package heph.plugin.v1;

import "google/protobuf/struct.proto";
import "google/protobuf/descriptor.proto";
import "heph/plugin/v1/plugin.proto";
import "google/protobuf/any.proto";

message ParseRequest {
  string request_id = 1;
  TargetSpec spec = 2;
}

message ParseResponse {
  TargetDef target = 1;
}

message ApplyTransitiveRequest {
  string request_id = 1;
  TargetDef target = 2;
  Sandbox transitive = 3;
}

message ApplyTransitiveResponse {
  TargetDef target = 1;
}

message ArtifactWithOrigin {
  Artifact artifact = 1;
  TargetDef.InputOrigin origin = 2;
}

message RunRequest {
  string request_id = 1;
  TargetDef target = 2;
  string sandbox_path = 3;
  string tree_root_path = 4;
  repeated ArtifactWithOrigin inputs = 5;
  repeated string pipes = 6;
}

message RunContainer {
  oneof msg {
    RunRequest start = 1;
    bool cancel = 2;
  }
}

message Artifact {
  enum Type {
    TYPE_UNSPECIFIED = 0;
    TYPE_OUTPUT = 1;
    TYPE_OUTPUT_LIST_V1 = 2;
    TYPE_LOG = 3;
    TYPE_MANIFEST_V1 = 4;
  }

  message ContentRaw {
    bytes data = 1;
    string path = 2;
    bool x = 3;
  }

  message ContentFile {
    string source_path = 1;
    string out_path = 2;
    bool x = 3;
  }

  string group = 1;
  string name = 2;
  Type type = 3;
  oneof content {
    ContentFile file = 4;
    ContentRaw raw = 5;
    string tar_path = 6;
    string targz_path = 7;
  }
}

message RunResponse {
  repeated Artifact artifacts = 1;
}

message ConfigRequest {}

message ConfigResponse {
  string name = 1;
  google.protobuf.DescriptorProto target_schema = 2;
}

message PipeRequest {
  string request_id = 1;
}

message PipeResponse {
  string id = 1;
  string path = 2;
}

service Driver {
  rpc Config(ConfigRequest) returns (ConfigResponse) {}
  rpc Parse(ParseRequest) returns (ParseResponse) {}
  rpc ApplyTransitive(ApplyTransitiveRequest) returns (ApplyTransitiveResponse) {}
  rpc Run(stream RunContainer) returns (stream RunResponse) {}
  rpc Pipe(PipeRequest) returns (PipeResponse) {}
}
